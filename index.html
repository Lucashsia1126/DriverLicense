<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lalamove è­‰ä»¶æ‹æ” (V11 æ‰¹æ¬¡ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <style>
        /* --- V11 æ–°å¢ï¼šCSS è®Šæ•¸å®šç¾© (Lalamove æ©˜è‰²ç³») --- */
        :root {
            --primary-orange: #ff6600;       /* Lalamove æ¨™æº–æ©˜ */
            --primary-orange-hover: #e55c00; /* æ·±æ©˜è‰² (Hoverç”¨) */
            --light-orange-bg: #fff5f0;      /* æ·ºæ©˜è‰²èƒŒæ™¯ */
            --orange-border: #ffcc99;        /* æ©˜è‰²é‚Šæ¡† */
            --text-dark: #333;
            --grey-btn: #6c757d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 15px;
            padding-bottom: 100px;
            color: var(--text-dark);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            /* é ‚éƒ¨å¢åŠ ä¸€æ¢æ©˜è‰²ç·šæ¢è£é£¾ */
            border-top: 4px solid var(--primary-orange);
        }

        h1 { text-align: center; color: #444; font-size: 20px; margin-bottom: 20px; }

        .input-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 10px;
            background-color: #fcfcfc;
            transition: all 0.3s;
        }
        /* V11 ä¿®æ”¹ï¼šé«˜äº®è‰²ç³»æ”¹ç‚ºæ·ºæ©˜è‰² */
        .input-group.highlight {
            background-color: var(--light-orange-bg);
            border-color: var(--orange-border);
        }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #444; font-size: 15px; }

        input[type="text"] {
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;
        }
        input[type="text"]:focus {
            border-color: var(--primary-orange);
            outline: none;
        }
        input[type="file"] { display: none; }

        /* V11 ä¿®æ”¹ï¼šä¸Šå‚³æŒ‰éˆ•æ©˜è‰²åŒ– */
        .upload-btn {
            display: block; width: 100%; padding: 12px; background-color: var(--primary-orange); color: white;
            text-align: center; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer;
            transition: background 0.2s;
        }
        .upload-btn:hover { background-color: var(--primary-orange-hover); }
        
        .preview-box { margin-top: 15px; text-align: center; display: none; }
        .preview-box img { 
            max-width: 100%; 
            border-radius: 4px; 
            border: 1px solid #ddd; 
            display: block;
            margin: 0 auto 10px auto;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            transition: background 0.2s;
        }
        .btn-dl { background-color: var(--grey-btn); } 
        /* V11 ä¿®æ”¹ï¼šå€‹åˆ¥åˆ†äº«æŒ‰éˆ•ä¹Ÿæ”¹ç‚ºæ©˜è‰²ï¼Œä¿æŒä¸»é¡Œä¸€è‡´ */
        .btn-share { background-color: var(--primary-orange); } 
        .btn-share:hover { background-color: var(--primary-orange-hover); }

        /* --- V11 æ–°å¢ï¼šåº•éƒ¨æ‰¹æ¬¡æ“ä½œå€æ¨£å¼ --- */
        .batch-actions-area {
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px dashed #eee;
            text-align: center;
        }
        .batch-btn-main {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-orange);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(255, 102, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .batch-btn-main:hover:not(:disabled) {
            background-color: var(--primary-orange-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(255, 102, 0, 0.3);
        }
        .batch-btn-main:disabled {
            background-color: #ccc;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.8;
        }
        .batch-note {
            margin-top: 10px;
            font-size: 13px;
            color: #888;
        }

        /* --- è£åˆ‡è¦–çª— --- */
        #cropperModal {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #000; z-index: 9999;
            display: none; flex-direction: column;
        }
        .cropper-wrapper {
            flex: 1; min-height: 0; overflow: hidden; position: relative; background-color: #000;
        }
        #imageToCrop { display: block; max-width: 100%; max-height: 100%; }
        
        .cropper-controls {
            height: 80px; background: #111; display: flex;
            justify-content: space-between; align-items: center; padding: 0 15px;
            flex-shrink: 0; z-index: 10000;
        }
        .cropper-btn {
            padding: 10px 16px; border-radius: 8px; border: none; font-size: 14px; font-weight: bold; color: #fff; cursor: pointer;
        }
        .btn-cancel { background: #555; }
        /* æ—‹è½‰æŒ‰éˆ•ä¿ç•™å†·è‰²èª¿ä»¥ç¤ºå€åˆ¥ï¼Œæˆ–ä¹Ÿå¯æ”¹ç‚ºæ·±ç°è‰² */
        .btn-rotate { background: #17a2b8; } 
        /* V11 ä¿®æ”¹ï¼šç¢ºèªæŒ‰éˆ•æ©˜è‰²åŒ– */
        .btn-confirm { background: var(--primary-orange); padding: 10px 24px; font-size: 16px; }

        /* --- Loading é®ç½© --- */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 20000; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3; 
            /* V11 ä¿®æ”¹ï¼šLoading å‹•ç•«æ©˜è‰²åŒ– */
            border-top: 4px solid var(--primary-orange);
            border-radius: 50%; animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        .loading-text { color: #fff; font-weight: bold; font-size: 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">è™•ç†ä¸­...</div>
</div>

<div class="container">
    <h1>ğŸšš Lalamove è­‰ä»¶æ‹æ”åŠ©æ‰‹ (V11)</h1>

    <div class="input-group highlight">
        <label>æ­¥é©Ÿ 1ï¼šè¼¸å…¥å§“å (å¿…å¡«)</label>
        <input type="text" id="userName" placeholder="è«‹è¼¸å…¥å¸æ©Ÿå§“å">
    </div>

    <div class="input-group">
        <label>1. èº«ä»½è­‰ (æ­£é¢)</label>
        <label for="input_id_front" class="upload-btn">ğŸ“¸ æ‹æ”ä¸¦è£åˆ‡</label>
        <input type="file" id="input_id_front" accept="image/*" onchange="handleFileSelect(this, 'èº«ä»½è­‰', 'æ­£é¢')">
        <div class="preview-box" id="preview_id_front">
            <img id="img_id_front">
            <div class="action-buttons" id="actions_id_front" style="display:none;">
                <button class="action-btn btn-dl" onclick="triggerDownload('id_front')">â¬‡ï¸ ä¸‹è¼‰</button>
                <button class="action-btn btn-share" onclick="triggerShare('id_front')">ğŸ“¤ åˆ†äº«</button>
            </div>
        </div>
    </div>
    
    <div class="input-group">
        <label>2. èº«ä»½è­‰ (åé¢)</label>
        <label for="input_id_back" class="upload-btn">ğŸ“¸ æ‹æ”ä¸¦è£åˆ‡</label>
        <input type="file" id="input_id_back" accept="image/*" onchange="handleFileSelect(this, 'èº«ä»½è­‰', 'åé¢')">
        <div class="preview-box" id="preview_id_back">
            <img id="img_id_back">
            <div class="action-buttons" id="actions_id_back" style="display:none;">
                <button class="action-btn btn-dl" onclick="triggerDownload('id_back')">â¬‡ï¸ ä¸‹è¼‰</button>
                <button class="action-btn btn-share" onclick="triggerShare('id_back')">ğŸ“¤ åˆ†äº«</button>
            </div>
        </div>
    </div>
    
    <div class="input-group">
        <label>3. è·æ¥­é§•ç…§ (æ­£é¢)</label>
        <label for="input_pro_front" class="upload-btn">ğŸ“¸ æ‹æ”ä¸¦è£åˆ‡</label>
        <input type="file" id="input_pro_front" accept="image/*" onchange="handleFileSelect(this, 'è·æ¥­é§•ç…§', 'æ­£é¢')">
        <div class="preview-box" id="preview_pro_front">
            <img id="img_pro_front">
            <div class="action-buttons" id="actions_pro_front" style="display:none;">
                <button class="action-btn btn-dl" onclick="triggerDownload('pro_front')">â¬‡ï¸ ä¸‹è¼‰</button>
                <button class="action-btn btn-share" onclick="triggerShare('pro_front')">ğŸ“¤ åˆ†äº«</button>
            </div>
        </div>
    </div>

    <div class="input-group">
        <label>4. è·æ¥­é§•ç…§ (åé¢)</label>
        <label for="input_pro_back" class="upload-btn">ğŸ“¸ æ‹æ”ä¸¦è£åˆ‡</label>
        <input type="file" id="input_pro_back" accept="image/*" onchange="handleFileSelect(this, 'è·æ¥­é§•ç…§', 'åé¢')">
        <div class="preview-box" id="preview_pro_back">
            <img id="img_pro_back">
            <div class="action-buttons" id="actions_pro_back" style="display:none;">
                <button class="action-btn btn-dl" onclick="triggerDownload('pro_back')">â¬‡ï¸ ä¸‹è¼‰</button>
                <button class="action-btn btn-share" onclick="triggerShare('pro_back')">ğŸ“¤ åˆ†äº«</button>
            </div>
        </div>
    </div>

    <div class="input-group">
        <label>5. é§•ç…§æ­£é¢ (ç„¡è·æ¥­é§•ç…§è€…)</label>
        <label for="input_std_front" class="upload-btn">ğŸ“¸ æ‹æ”ä¸¦è£åˆ‡</label>
        <input type="file" id="input_std_front" accept="image/*" onchange="handleFileSelect(this, 'é§•ç…§', 'æ­£é¢')">
        <div class="preview-box" id="preview_std_front">
            <img id="img_std_front">
            <div class="action-buttons" id="actions_std_front" style="display:none;">
                <button class="action-btn btn-dl" onclick="triggerDownload('std_front')">â¬‡ï¸ ä¸‹è¼‰</button>
                <button class="action-btn btn-share" onclick="triggerShare('std_front')">ğŸ“¤ åˆ†äº«</button>
            </div>
        </div>
    </div>

    <div class="batch-actions-area">
        <button id="batchShareBtn" class="batch-btn-main" onclick="triggerBatchShare()" disabled>
            <span style="font-size: 24px;">ğŸ“¤</span> æ‰¹æ¬¡åˆ†äº«å…¨éƒ¨ (0)
        </button>
        <div class="batch-note">(éœ€å®Œæˆè‡³å°‘ä¸€å¼µç…§ç‰‡çš„è£åˆ‡æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½)</div>
    </div>

</div>

<div id="cropperModal">
    <div class="cropper-wrapper">
        <img id="imageToCrop" src="">
    </div>
    <div class="cropper-controls">
        <button class="cropper-btn btn-cancel" onclick="cancelCropping()">å–æ¶ˆ</button>
        <button class="cropper-btn btn-rotate" onclick="rotateImage()">â†» æ—‹è½‰</button>
        <button class="cropper-btn btn-confirm" onclick="confirmCropping()">å®Œæˆ</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
    let cropper = null;
    let currentInputId = ''; 
    let currentDocType = '';
    let currentSide = '';
    
    // å„²å­˜è™•ç†å®Œæˆçš„ Blob è³‡æ–™
    const processedFiles = {}; 

    const modal = document.getElementById('cropperModal');
    const imageElement = document.getElementById('imageToCrop');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const WATERMARK_TEXT = "åƒ…ä¾›Lalamove ç§Ÿè»Šå°ˆæ¡ˆä½¿ç”¨";
    let activeObjectUrl = null;

    // --- V11 æ–°å¢ï¼šæ›´æ–°æ‰¹æ¬¡æŒ‰éˆ•ç‹€æ…‹ ---
    function updateBatchButtonState() {
        const count = Object.keys(processedFiles).length;
        const btn = document.getElementById('batchShareBtn');
        // æ›´æ–°æŒ‰éˆ•æ–‡å­—é¡¯ç¤ºæ•¸é‡
        btn.innerHTML = `<span style="font-size: 24px;">ğŸ“¤</span> æ‰¹æ¬¡åˆ†äº«å…¨éƒ¨ (${count})`;
        // å¦‚æœæ•¸é‡å¤§æ–¼ 0 å‰‡å•Ÿç”¨æŒ‰éˆ•ï¼Œå¦å‰‡ç¦ç”¨
        btn.disabled = count === 0;
    }

    function showLoading(text) { 
        if(text) document.querySelector('.loading-text').textContent = text;
        loadingOverlay.style.display = 'flex'; 
    }
    function hideLoading() { loadingOverlay.style.display = 'none'; }

    function handleFileSelect(input, docType, side) {
        const userName = document.getElementById('userName').value.trim();
        if (!userName) {
            alert("âš ï¸ è«‹å…ˆåœ¨æœ€ä¸Šæ–¹è¼¸å…¥å§“åï¼");
            input.value = '';
            document.getElementById('userName').focus();
            return;
        }

        if (input.files && input.files[0]) {
            showLoading("è¼‰å…¥ä¸­..."); 
            const file = input.files[0];
            currentInputId = input.id;
            currentDocType = docType;
            currentSide = side;
            setTimeout(() => { compressAndInit(file); }, 10);
        }
        input.value = '';
    }

    function compressAndInit(file) {
        if (activeObjectUrl) URL.revokeObjectURL(activeObjectUrl);
        const img = new Image();
        activeObjectUrl = URL.createObjectURL(file);
        
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const MAX_WIDTH = 1280; // ç¨å¾®æé«˜é è¦½è§£æåº¦
            let width = img.width;
            let height = img.height;

            if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            URL.revokeObjectURL(activeObjectUrl);

            canvas.toBlob((blob) => {
                if(blob) {
                    activeObjectUrl = URL.createObjectURL(blob);
                    startCropping(activeObjectUrl);
                } else {
                    alert("åœ–ç‰‡è¼‰å…¥éŒ¯èª¤"); hideLoading();
                }
            }, 'image/jpeg', 0.85);
        };
        img.onerror = function() { alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼"); hideLoading(); };
        img.src = activeObjectUrl;
    }

    function startCropping(imageSrc) {
        imageElement.src = imageSrc;
        modal.style.display = 'flex';
        if (cropper) cropper.destroy();
        cropper = new Cropper(imageElement, {
            aspectRatio: 85.6 / 54, // ID card ratio
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 0.9,
            background: false,
            responsive: true,
            ready: function() { hideLoading(); }
        });
    }

    function rotateImage() { if (cropper) cropper.rotate(90); }
    function cancelCropping() {
        modal.style.display = 'none';
        if (cropper) cropper.destroy();
        cropper = null;
        if (activeObjectUrl) URL.revokeObjectURL(activeObjectUrl);
        hideLoading();
    }

    function confirmCropping() {
        if (!cropper) return;
        showLoading("è™•ç†æµ®æ°´å°ä¸­...");

        setTimeout(() => {
            const croppedCanvas = cropper.getCroppedCanvas({
                width: 1200, 
                imageSmoothingQuality: 'high',
            });

            const finalCanvas = document.createElement('canvas');
            const ctx = finalCanvas.getContext('2d');
            finalCanvas.width = croppedCanvas.width;
            finalCanvas.height = croppedCanvas.height;
            ctx.drawImage(croppedCanvas, 0, 0);

            // --- æµ®æ°´å°ç¹ªè£½ ---
            ctx.save();
            ctx.translate(finalCanvas.width / 2, finalCanvas.height / 2);
            ctx.rotate(-25 * Math.PI / 180);
            
            const fontSize = Math.floor(finalCanvas.height / 12);
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            ctx.lineWidth = fontSize / 12;
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.4)'; // ç¨å¾®åŠ æ·±ä¸€é»
            ctx.strokeText(WATERMARK_TEXT, 0, 0);

            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)'; 
            ctx.fillText(WATERMARK_TEXT, 0, 0);
            ctx.restore();
            // ----------------

            finalCanvas.toBlob(function(blob) {
                const key = currentInputId.replace('input_', '');
                const userName = document.getElementById('userName').value.trim();
                // æª”åæ ¼å¼å„ªåŒ–
                const fileName = `Lalamove_${userName}_${currentDocType}_${currentSide}.jpg`;

                // å­˜å…¥å…¨åŸŸç‰©ä»¶
                processedFiles[key] = {
                    blob: blob,
                    fileName: fileName
                };

                // æ›´æ–°ç•«é¢
                const url = URL.createObjectURL(blob);
                document.getElementById('img_' + key).src = url;
                document.getElementById('preview_' + key).style.display = 'block';
                document.getElementById('actions_' + key).style.display = 'flex';

                // V11 é‡è¦ï¼šæ›´æ–°æ‰¹æ¬¡æŒ‰éˆ•ç‹€æ…‹
                updateBatchButtonState();

                cancelCropping();
                hideLoading();

            }, 'image/jpeg', 0.92); // æé«˜ä¸€é»è¼¸å‡ºå“è³ª

        }, 50);
    }

    // --- åŠŸèƒ½ï¼šå€‹åˆ¥ä¸‹è¼‰ ---
    function triggerDownload(key) {
        const fileData = processedFiles[key];
        if (!fileData) return;
        const url = URL.createObjectURL(fileData.blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = fileData.fileName;
        link.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    // --- åŠŸèƒ½ï¼šå€‹åˆ¥åˆ†äº« ---
    async function triggerShare(key) {
        const fileData = processedFiles[key];
        if (!fileData) return;
        if (navigator.share) {
            try {
                const file = new File([fileData.blob], fileData.fileName, { type: 'image/jpeg' });
                await navigator.share({
                    files: [file],
                    title: 'è­‰ä»¶åˆ†äº«',
                    text: fileData.fileName
                });
            } catch (error) {
                if (error.name !== 'AbortError') console.error('åˆ†äº«å¤±æ•—', error);
            }
        } else {
            alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åŸç”Ÿåˆ†äº«ï¼Œè«‹ä½¿ç”¨ä¸‹è¼‰åŠŸèƒ½ã€‚");
        }
    }

    // --- V11 æ–°å¢åŠŸèƒ½ï¼šæ‰¹æ¬¡åˆ†äº«å…¨éƒ¨ ---
    async function triggerBatchShare() {
        // 1. å°‡æ‰€æœ‰å·²è™•ç†çš„ Blob è½‰æ›ç‚º File é™£åˆ—
        const filesArray = [];
        for (const key in processedFiles) {
            if (processedFiles.hasOwnProperty(key)) {
                const fileData = processedFiles[key];
                // å»ºç«‹ File ç‰©ä»¶
                const file = new File([fileData.blob], fileData.fileName, { type: 'image/jpeg' });
                filesArray.push(file);
            }
        }

        // 2. é˜²å‘†æª¢æŸ¥
        if (filesArray.length === 0) {
            alert("å°šæœªè™•ç†ä»»ä½•ç…§ç‰‡ï¼");
            return;
        }

        // 3. æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´æ‰¹æ¬¡åˆ†äº«
        if (navigator.share && navigator.canShare && navigator.canShare({ files: filesArray })) {
            try {
                showLoading("æº–å‚™æ‰¹æ¬¡åˆ†äº«...");
                // å‘¼å«åŸç”Ÿåˆ†äº«é¸å–®
                await navigator.share({
                    files: filesArray,
                    title: 'Lalamove è­‰ä»¶æ‰¹æ¬¡ä¸Šå‚³',
                    text: `å¸æ©Ÿ ${document.getElementById('userName').value} çš„ ${filesArray.length} å¼µè­‰ä»¶ç…§ç‰‡`
                });
                console.log('æ‰¹æ¬¡åˆ†äº«æˆåŠŸ');
            } catch (error) {
                // ä½¿ç”¨è€…å–æ¶ˆåˆ†äº«ä¸è¦–ç‚ºéŒ¯èª¤ï¼Œå…¶ä»–éŒ¯èª¤æ‰è·³æç¤º
                if (error.name !== 'AbortError') {
                    console.error('æ‰¹æ¬¡åˆ†äº«å¤±æ•—', error);
                    alert("åˆ†äº«éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼Œæˆ–æ”¹ç”¨å€‹åˆ¥ä¸‹è¼‰ã€‚");
                }
            } finally {
                hideLoading();
            }
        } else {
            // è‹¥ä¸æ”¯æ´ï¼Œæç¤ºä½¿ç”¨è€…
            alert("æ‚¨çš„æ‰‹æ©Ÿæˆ–ç€è¦½å™¨ä¸æ”¯æ´ä¸€æ¬¡åˆ†äº«å¤šå€‹æª”æ¡ˆã€‚\n\nè«‹ä½¿ç”¨ä¸Šæ–¹å€‹åˆ¥ç…§ç‰‡çš„ã€Œâ¬‡ï¸ ä¸‹è¼‰ã€æŒ‰éˆ•ï¼Œå†æ‰‹å‹•ä¸Šå‚³ã€‚");
        }
    }
</script>

</body>
</html>
