<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lalamove è­‰ä»¶æ‹æ” (V10 )</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 15px;
            padding-bottom: 100px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        h1 { text-align: center; color: #444; font-size: 20px; margin-bottom: 20px; }

        .input-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 10px;
            background-color: #fcfcfc;
        }
        .input-group.highlight {
            background-color: #e8f4ff;
            border-color: #b3d7ff;
        }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #444; font-size: 15px; }

        input[type="text"] {
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;
        }
        input[type="file"] { display: none; }

        .upload-btn {
            display: block; width: 100%; padding: 12px; background-color: #007aff; color: white;
            text-align: center; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer;
            transition: background 0.2s;
        }
        .upload-btn:hover { background-color: #0069d9; }
        
        /* é è¦½å€å¡Šå„ªåŒ– */
        .preview-box { margin-top: 15px; text-align: center; display: none; }
        .preview-box img { 
            max-width: 100%; 
            border-radius: 4px; 
            border: 1px solid #ddd; 
            display: block;
            margin: 0 auto 10px auto;
        }

        /* --- V10 æ–°å¢ï¼šæŒ‰éˆ•ç¾¤çµ„ --- */
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }
        .btn-dl { background-color: #6c757d; } /* ç°è‰²ä¸‹è¼‰éˆ• */
        .btn-share { background-color: #28a745; } /* ç¶ è‰²åˆ†äº«éˆ• */

        /* --- è£åˆ‡è¦–çª— --- */
        #cropperModal {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #000; z-index: 9999;
            display: none; flex-direction: column;
        }
        .cropper-wrapper {
            flex: 1; min-height: 0; overflow: hidden; position: relative; background-color: #000;
        }
        #imageToCrop { display: block; max-width: 100%; max-height: 100%; }
        
        .cropper-controls {
            height: 80px; background: #111; display: flex;
            justify-content: space-between; align-items: center; padding: 0 15px;
            flex-shrink: 0; z-index: 10000;
        }
        .cropper-btn {
            padding: 10px 16px; border-radius: 8px; border: none; font-size: 14px; font-weight: bold; color: #fff; cursor: pointer;
        }
        .btn-cancel { background: #555; }
        .btn-rotate { background: #17a2b8; }
        .btn-confirm { background: #007aff; padding: 10px 24px; font-size: 16px; }

        /* --- Loading é®ç½© --- */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 20000; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3; border-top: 4px solid #007aff;
            border-radius: 50%; animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        .loading-text { color: #fff; font-weight: bold; font-size: 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">è™•ç†ä¸­...</div>
</div>

<div class="container">
    <h1>Lalamove è­‰ä»¶æ‹æ”åŠ©æ‰‹ (V10)</h1>

    <div class="input-group highlight">
        <label>æ­¥é©Ÿ 1ï¼šè¼¸å…¥å§“å</label>
        <input type="text" id="userName" placeholder="è«‹è¼¸å…¥å¸æ©Ÿå§“å">
    </div>

    <div class="input-group">
        <label>1. èº«ä»½è­‰ (æ­£é¢)</label>
        <label for="input_id_front" class="upload-btn">ğŸ“¸ æ‹æ”ä¸¦è£åˆ‡</label>
        <input type="file" id="input_id_front" accept="image/*" onchange="handleFileSelect(this, 'èº«ä»½è­‰', 'æ­£é¢')">
        <div class="preview-box" id="preview_id_front">
            <img id="img_id_front">
            <div class="action-buttons" id="actions_id_front" style="display:none;">
                <button class="action-btn btn-dl" onclick="triggerDownload('id_front')">â¬‡ï¸ åƒ…ä¸‹è¼‰</button>
                <button class="action-btn btn-share" onclick="triggerShare('id_front')">ğŸ“¤ åˆ†äº« / é›²ç«¯</button>
            </div>
        </div>
    </div>
    
    <div class="input-group">
        <label>2. èº«ä»½è­‰ (åé¢)</label>
        <label for="input_id_back" class="upload-btn">ğŸ“¸ æ‹æ”ä¸¦è£åˆ‡</label>
        <input type="file" id="input_id_back" accept="image/*" onchange="handleFileSelect(this, 'èº«ä»½è­‰', 'åé¢')">
        <div class="preview-box" id="preview_id_back">
            <img id="img_id_back">
            <div class="action-buttons" id="actions_id_back" style="display:none;">
                <button class="action-btn btn-dl" onclick="triggerDownload('id_back')">â¬‡ï¸ åƒ…ä¸‹è¼‰</button>
                <button class="action-btn btn-share" onclick="triggerShare('id_back')">ğŸ“¤ åˆ†äº« / é›²ç«¯</button>
            </div>
        </div>
    </div>
    
    <div class="input-group">
        <label>3. è·æ¥­é§•ç…§ (æ­£é¢)</label>
        <label for="input_pro_front" class="upload-btn">ğŸ“¸ æ‹æ”ä¸¦è£åˆ‡</label>
        <input type="file" id="input_pro_front" accept="image/*" onchange="handleFileSelect(this, 'è·æ¥­é§•ç…§', 'æ­£é¢')">
        <div class="preview-box" id="preview_pro_front">
            <img id="img_pro_front">
            <div class="action-buttons" id="actions_pro_front" style="display:none;">
                <button class="action-btn btn-dl" onclick="triggerDownload('pro_front')">â¬‡ï¸ åƒ…ä¸‹è¼‰</button>
                <button class="action-btn btn-share" onclick="triggerShare('pro_front')">ğŸ“¤ åˆ†äº« / é›²ç«¯</button>
            </div>
        </div>
    </div>

    <div class="input-group">
        <label>4. è·æ¥­é§•ç…§ (åé¢)</label>
        <label for="input_pro_back" class="upload-btn">ğŸ“¸ æ‹æ”ä¸¦è£åˆ‡</label>
        <input type="file" id="input_pro_back" accept="image/*" onchange="handleFileSelect(this, 'è·æ¥­é§•ç…§', 'åé¢')">
        <div class="preview-box" id="preview_pro_back">
            <img id="img_pro_back">
            <div class="action-buttons" id="actions_pro_back" style="display:none;">
                <button class="action-btn btn-dl" onclick="triggerDownload('pro_back')">â¬‡ï¸ åƒ…ä¸‹è¼‰</button>
                <button class="action-btn btn-share" onclick="triggerShare('pro_back')">ğŸ“¤ åˆ†äº« / é›²ç«¯</button>
            </div>
        </div>
    </div>

    <div class="input-group">
        <label>5. é§•ç…§æ­£é¢ (ç„¡è·æ¥­é§•ç…§è€…)</label>
        <label for="input_std_front" class="upload-btn">ğŸ“¸ æ‹æ”ä¸¦è£åˆ‡</label>
        <input type="file" id="input_std_front" accept="image/*" onchange="handleFileSelect(this, 'é§•ç…§', 'æ­£é¢')">
        <div class="preview-box" id="preview_std_front">
            <img id="img_std_front">
            <div class="action-buttons" id="actions_std_front" style="display:none;">
                <button class="action-btn btn-dl" onclick="triggerDownload('std_front')">â¬‡ï¸ åƒ…ä¸‹è¼‰</button>
                <button class="action-btn btn-share" onclick="triggerShare('std_front')">ğŸ“¤ åˆ†äº« / é›²ç«¯</button>
            </div>
        </div>
    </div>
</div>

<div id="cropperModal">
    <div class="cropper-wrapper">
        <img id="imageToCrop" src="">
    </div>
    <div class="cropper-controls">
        <button class="cropper-btn btn-cancel" onclick="cancelCropping()">å–æ¶ˆ</button>
        <button class="cropper-btn btn-rotate" onclick="rotateImage()">â†» æ—‹è½‰</button>
        <button class="cropper-btn btn-confirm" onclick="confirmCropping()">å®Œæˆ</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
    let cropper = null;
    // ç‹€æ…‹è®Šæ•¸
    let currentInputId = ''; 
    let currentDocType = '';
    let currentSide = '';
    
    // å„²å­˜è™•ç†å®Œæˆçš„ Blob è³‡æ–™ï¼Œä¾›æŒ‰éˆ•ä½¿ç”¨
    const processedFiles = {}; 

    const modal = document.getElementById('cropperModal');
    const imageElement = document.getElementById('imageToCrop');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const WATERMARK_TEXT = "åƒ…ä¾›Lalamove ç§Ÿè»Šå°ˆæ¡ˆä½¿ç”¨";
    let activeObjectUrl = null;

    function showLoading(text) { 
        if(text) document.querySelector('.loading-text').textContent = text;
        loadingOverlay.style.display = 'flex'; 
    }
    function hideLoading() { loadingOverlay.style.display = 'none'; }

    function handleFileSelect(input, docType, side) {
        const userName = document.getElementById('userName').value.trim();
        if (!userName) {
            alert("âš ï¸ è«‹å…ˆåœ¨æœ€ä¸Šæ–¹è¼¸å…¥å§“åï¼");
            input.value = '';
            document.getElementById('userName').focus();
            return;
        }

        if (input.files && input.files[0]) {
            showLoading("è¼‰å…¥ä¸­..."); 
            const file = input.files[0];
            currentInputId = input.id;
            currentDocType = docType;
            currentSide = side;
            setTimeout(() => { compressAndInit(file); }, 10);
        }
        input.value = '';
    }

    function compressAndInit(file) {
        if (activeObjectUrl) URL.revokeObjectURL(activeObjectUrl);
        const img = new Image();
        activeObjectUrl = URL.createObjectURL(file);
        
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // é è¦½å£“ç¸®è‡³ 960px
            const MAX_WIDTH = 960;
            let width = img.width;
            let height = img.height;

            if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            URL.revokeObjectURL(activeObjectUrl);

            canvas.toBlob((blob) => {
                if(blob) {
                    activeObjectUrl = URL.createObjectURL(blob);
                    startCropping(activeObjectUrl);
                } else {
                    alert("éŒ¯èª¤"); hideLoading();
                }
            }, 'image/jpeg', 0.8);
        };
        img.onerror = function() { alert("è®€å–å¤±æ•—"); hideLoading(); };
        img.src = activeObjectUrl;
    }

    function startCropping(imageSrc) {
        imageElement.src = imageSrc;
        modal.style.display = 'flex';
        if (cropper) cropper.destroy();
        cropper = new Cropper(imageElement, {
            aspectRatio: 85.6 / 54,
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 0.9,
            background: false,
            responsive: true,
            ready: function() { hideLoading(); }
        });
    }

    function rotateImage() { if (cropper) cropper.rotate(90); }
    function cancelCropping() {
        modal.style.display = 'none';
        if (cropper) cropper.destroy();
        cropper = null;
        if (activeObjectUrl) URL.revokeObjectURL(activeObjectUrl);
        hideLoading();
    }

    function confirmCropping() {
        if (!cropper) return;
        showLoading("è™•ç†ä¸­...");

        setTimeout(() => {
            const croppedCanvas = cropper.getCroppedCanvas({
                width: 1200, 
                imageSmoothingQuality: 'high',
            });

            const finalCanvas = document.createElement('canvas');
            const ctx = finalCanvas.getContext('2d');
            finalCanvas.width = croppedCanvas.width;
            finalCanvas.height = croppedCanvas.height;
            ctx.drawImage(croppedCanvas, 0, 0);

            // --- æµ®æ°´å° ---
            ctx.save();
            ctx.translate(finalCanvas.width / 2, finalCanvas.height / 2);
            ctx.rotate(-25 * Math.PI / 180);
            
            const fontSize = Math.floor(finalCanvas.height / 12);
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            ctx.lineWidth = fontSize / 12;
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)'; 
            ctx.strokeText(WATERMARK_TEXT, 0, 0);

            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)'; 
            ctx.fillText(WATERMARK_TEXT, 0, 0);
            ctx.restore();
            // -------------

            // è½‰æˆ Blob å„²å­˜èµ·ä¾†ï¼Œä¸ç›´æ¥ä¸‹è¼‰
            finalCanvas.toBlob(function(blob) {
                // 1. ç”Ÿæˆå”¯ä¸€ key (ä¾‹å¦‚ id_front)
                const key = currentInputId.replace('input_', ''); // e.g., id_front
                
                // 2. æº–å‚™æª”å
                const userName = document.getElementById('userName').value.trim();
                const fileName = `${userName}_${currentDocType}_${currentSide}.jpg`;

                // 3. å­˜å…¥å…¨åŸŸè®Šæ•¸
                processedFiles[key] = {
                    blob: blob,
                    fileName: fileName
                };

                // 4. æ›´æ–°ç•«é¢é è¦½åœ–
                const url = URL.createObjectURL(blob);
                document.getElementById('img_' + key).src = url;

                // 5. é¡¯ç¤ºæ“ä½œæŒ‰éˆ•
                document.getElementById('preview_' + key).style.display = 'block';
                document.getElementById('actions_' + key).style.display = 'flex';

                cancelCropping();
                hideLoading();

            }, 'image/jpeg', 0.9);

        }, 20);
    }

    // --- åŠŸèƒ½å‡½å¼ï¼šä¸‹è¼‰ ---
    function triggerDownload(key) {
        const fileData = processedFiles[key];
        if (!fileData) return;

        const url = URL.createObjectURL(fileData.blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = fileData.fileName;
        link.click();
        
        // å»¶é²é‡‹æ”¾
        setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    // --- åŠŸèƒ½å‡½å¼ï¼šåˆ†äº« / ä¸Šå‚³ ---
    async function triggerShare(key) {
        const fileData = processedFiles[key];
        if (!fileData) return;

        // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ Web Share API
        if (navigator.share) {
            try {
                // å°‡ Blob è½‰ç‚º File ç‰©ä»¶
                const file = new File([fileData.blob], fileData.fileName, { type: 'image/jpeg' });

                await navigator.share({
                    files: [file],
                    title: 'è­‰ä»¶ç…§ä¸Šå‚³',
                    text: `Lalamove è­‰ä»¶ç…§: ${fileData.fileName}`
                });
                console.log('åˆ†äº«æˆåŠŸ');
            } catch (error) {
                console.log('åˆ†äº«å–æ¶ˆæˆ–å¤±æ•—', error);
            }
        } else {
            alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åŸç”Ÿåˆ†äº«åŠŸèƒ½ï¼Œè«‹ä½¿ç”¨ã€Œä¸‹è¼‰ã€æŒ‰éˆ•ã€‚");
        }
    }
</script>

</body>
</html>
